---
title: "ABCD SL Analysis"
author: "Zhenghan Qi"
date: "July 24, 2020"
output: pdf_document
---
```{r,echo=FALSE,warning=FALSE,include=FALSE}
#Loading library
library(ggplot2)
library(knitr)
library(readr)
library(reshape)
library(reshape2)
library(lmerTest)
library(scales)
library(ggbeeswarm)
library(Hmisc)
library(magrittr)
library(qwraps2)
library(tidyverse)
library(dplyr)
library(tibble)
library(ggpubr)
library(rstatix)
```

```{r,echo=FALSE}
#Initialize variables
total_participant <- 40 #40 vsl participants and 40 tsl participants
total_vsl_trial <- 24 #number of trials in the familiarization block
total_tsl_trial <- 48
length_vsl <- 533 #number of rows in a vsl excel file
length_tsl <- 832 #number of rows in a tsl excel file
total_test_trial <- 32
```


```{r,echo=FALSE}
#Note: The code below is to work on the raw files to combine them. You can import the already combined vsl from /abcd/raw/summary/vsl.csv and tsl files if you just want to look at the analysis part.

#importing raw files
tsl <- list()
vsl <- list()
vsl_par_id <- NULL
tsl_par_id <- NULL
path <- "/Users/zhenghanqi/Dropbox (MIT)/UDel/projects/collaboration/abcd/raw/"  
files <- list.files(path=path, pattern="*tsl.csv") 
vsl_files <- list.files(path=path, pattern="*vsl.csv")

for(file in files)
{
   
    assign(
        gsub(" ","",file), 
        read.csv(paste(path,file,sep="")))
}
for(file in files){tsl <- append(tsl,list(eval(parse(text=file))))}

for(vslfile in vsl_files)
{
    assign(
        gsub(" ","",vslfile), 
        read.csv(paste(path,vslfile,sep="")))
}
for(text in vsl_files){vsl <- append(vsl,list(eval(parse(text=text))))}

vsl <- do.call(rbind.data.frame, vsl)
tsl <- do.call(rbind.data.frame, tsl)

#add an ID column for each row
for (i in seq(from=1,to=length(vsl$responses),by=length_vsl)){vsl_par_id<-append(vsl_par_id,rep(substr(vsl$responses[i],8,16),length_vsl))}
for (i in seq(from=1,to=length(tsl$responses),by=length_tsl)){tsl_par_id<-append(tsl_par_id,rep(substr(tsl$responses[i],8,16),length_tsl))}
vsl$par_id <- vsl_par_id
tsl$par_id <- tsl_par_id

#Group set up: 17 DD and 24 TYP
DD <- list("ABCD_1711", "ABCD_1714", "ABCD_1727", "ABCD_1735", "ABCD_1751", "ABCD_1756", "ABCD_1764", "ABCD_1767", "ABCD_1768", "ABCD_1776","ABCD_1777","ABCD_1778", "ABCD_1781", "ABCD_1784", "ABCD_1787", "ABCD_1792", "ABCD_1794")

TYP <- list("ABCD_1702", "ABCD_1703", "ABCD_1705", "ABCD_1708", "ABCD_1709", "ABCD_1710", "ABCD_1716", "ABCD_1720", "ABCD_1721", "ABCD_1724", "ABCD_1725", "ABCD_1728", "ABCD_1729", "ABCD_1730", "ABCD_1732", "ABCD_1734", "ABCD_1736", "ABCD_1739", "ABCD_1742", "ABCD_1747", "ABCD_1749", "ABCD_1754", "ABCD_1783", "ABCD_1788" )
group <- NULL
for (i in seq(from=1,to=length(tsl$par_id),by=1))
    {if (tsl[i,]$par_id %in% TYP)
    {group[i]<-"TYP"}
    else if (tsl[i,]$par_id %in% DD)
    {group[i] <- "DD"}}
tsl$group <- group
groupv <- NULL
for (i in seq(from=1,to=length(vsl$par_id),by=1))
    {if (vsl[i,]$par_id %in% TYP)
    {groupv[i]<-"TYP"}
    else if (vsl[i,]$par_id %in% DD)
    {groupv[i] <- "DD"}}
vsl$group <- groupv


#Get the ID of every participant
list_tsl_id <- unique(tsl$par_id)
list_vsl_id <- unique(vsl$par_id)


language_1 = list(1,2,2,2,1,1,2,1,1,2,1,2,1,1,2,2,1,1,2,1,2,2,1,2,2,2,1,2,1,2,1,1)
language_2 = list(1,1,2,1,1,1,2,2,2,2,1,1,1,2,2,1,2,2,1,1,2,1,2,1,2,1,2,1,1,2,2,2)
```

```{r,echo=FALSE}
#Clean data: remove file extension and path of the stimuli so the format of the stimuli match with the target

vsl$stimulus<- gsub(".jpg","",vsl$stimulus)
vsl$stimulus<- gsub("../../images/","",vsl$stimulus)

tsl$stimulus<- gsub(".wav","",tsl$stimulus)
tsl$stimulus<- gsub("../../tones/","",tsl$stimulus)
```

#Compute RT for VSL
* two groups are not different in target detection d-prime
* the DD group showed a significantly negative RT slope
* the TYP group showed a nonsignificantly negative RT slope
```{r,echo=FALSE}
compute_visual <- function(data)
{
rt_col <- NULL
id <- NULL
trial <- NULL
target <- NULL
group_cond <- NULL

row_number <- which(vsl$targ==vsl$stimulus) #extract rows in which stimuli match with target
for (i in row_number){
        rt_col <- append(rt_col,vsl[i,][,"rt"])
        trial <- append(trial,vsl[i,][,"trial_index"])
        id <- append(id,vsl[i,]$par_id)
        group_cond <- append(group_cond,vsl[i,]$group)
    if (vsl[i-1,][,"rt"]!=-1){
        rt_col[(match(i,row_number))] <- -(1000-vsl[i-1,][,"rt"])
    }}

rt_df1 <- data.frame(trial,rt_col,id,group_cond) 
#NOTE: Depending on your version of R and your setting, the lines below may run inaccurately. You can check type rt_df1 after running this line to check if it returns a correct data frame. If not, run these two lines instead: 
#rt_df1 <- data.frame(unlist(trial),unlist(rt_col),id,group_cond) 
#colnames(rt_df1) <- c("trial","rt_col","id","group_cond")

fam_block <- vsl[which(vsl$trial_index<=300 & vsl$trial_index>=12),] #the familiarization block starts with index number 13 and ends with index 300
fam_trial <- rt_df1[which(rt_df1$trial<=300 & rt_df1$trial>=12), ]
reindex <- rep(1:total_vsl_trial,total_participant)
fam_trial$reindex <- reindex
fam_trial <- fam_trial[which(!is.na(fam_trial$group_cond)),]

hit_rate <- NULL
miss_rate <- NULL
correct_rejection <- NULL
false_alarm <- NULL
mean_rt <- NULL
rt_slope <- NULL
mean_table <- fam_trial[which(fam_trial$rt_col!=-1 & fam_trial$rt_col<1000 & fam_trial$rt_col>-1000), ] #only accept answers in range of -1000 < x < 1000

list_vsl_id <- unique(mean_table$id)

for(id in list_vsl_id){
  mean_rt<-append(mean_rt,round(mean(mean_table$rt_col[mean_table$id==id]),digits=3))
  rt_slope <-append(rt_slope,round(summary(lm(mean_table$rt_col[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  hit_rate<-append(hit_rate,round(sum(!is.na(mean_table$rt_col[mean_table$id==id]))/total_vsl_trial,digits =2))
  miss_rate<-append(miss_rate,round(sum(fam_trial$rt_col[fam_trial$id==id]==-1)/total_vsl_trial,digits=2))
  correct_rejection <- append(correct_rejection, round(sum(fam_block$rt[fam_block$par_id==id]==-1 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/264,digits=3)) #264 is the total number of stimuli in the familiarization block
  false_alarm <- append(false_alarm, round(sum(fam_block$rt[fam_block$par_id==id]!=-1 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/264,digits=3))
}

subj_table <- data.frame(list_vsl_id,mean_rt, rt_slope,hit_rate, miss_rate,correct_rejection,false_alarm)
dprime<-NULL
for (i in seq(from=1,to=length(subj_table$list_vsl_id),by=1)){dprime<-append(dprime,qnorm(subj_table[i,]$hit_rate-0.00000001)-qnorm(subj_table[i,]$false_alarm+0.000000001))} #minus 0.000000001 to avoid perfect hit rate
subj_table$dprime <- dprime

#colnames(subj_table) <- c("VSL_ID","mean_rt", "rt_slope","hit", "miss","corr_rejection","false_alarm","dprime")
#print(kable(subj_table,format = "pandoc"))

group <- NULL
for (i in seq(from=1,to=length(subj_table$list_vsl_id),by=1))
    {if (subj_table[i,]$list_vsl_id %in% TYP)
    {group[i]<-"TYP"}
    else if (subj_table[i,]$list_vsl_id %in% DD)
    {group[i] <- "DD"}}
subj_table$group <- group

vrtdd <- t.test(subj_table$rt_slope[subj_table$group=="DD"],mu=0,alternative="less")
vrttyp <- t.test(subj_table$rt_slope[subj_table$group=="TYP"],mu=0,alternative="less")
vdd_v_typ <- t.test(rt_slope~group,data=subj_table)
model3 <- wilcox.test(dprime~group,data=subj_table)
model4 <- wilcox.test(mean_rt~group,data=subj_table)
print(model3)
print(model4)
print(vrtdd)
print(vrttyp)
return(mean_table)
}

compute_visual_scale <- function(data)
{
rt_col <- NULL
id <- NULL
trial <- NULL
target <- NULL
group_cond <- NULL

row_number <- which(vsl$targ==vsl$stimulus) #extract rows in which stimuli match with target
for (i in row_number){
        rt_col <- append(rt_col,vsl[i,][,"rt"])
        trial <- append(trial,vsl[i,][,"trial_index"])
        id <- append(id,vsl[i,]$par_id)
        group_cond <- append(group_cond,vsl[i,]$group)
    if (vsl[i-1,][,"rt"]!=-1){
        rt_col[(match(i,row_number))] <- -(1000-vsl[i-1,][,"rt"])
    }}

rt_df1 <- data.frame(trial,rt_col,id,group_cond) 
#NOTE: Depending on your version of R and your setting, the lines below may run inaccurately. You can check type rt_df1 after running this line to check if it returns a correct data frame. If not, run these two lines instead: 
#rt_df1 <- data.frame(unlist(trial),unlist(rt_col),id,group_cond) 
#colnames(rt_df1) <- c("trial","rt_col","id","group_cond")

fam_block <- vsl[which(vsl$trial_index<=300 & vsl$trial_index>=12),] #the familiarization block starts with index number 13 and ends with index 300
fam_trial <- rt_df1[which(rt_df1$trial<=300 & rt_df1$trial>=12), ]
reindex <- rep(1:total_vsl_trial,total_participant)
fam_trial$reindex <- reindex
fam_trial <- fam_trial[which(!is.na(fam_trial$group_cond)),]

hit_rate <- NULL
miss_rate <- NULL
correct_rejection <- NULL
false_alarm <- NULL
mean_rt <- NULL
rt_slope <- NULL
mean_table <- fam_trial[which(fam_trial$rt_col!=-1 & fam_trial$rt_col<1000 & fam_trial$rt_col>-1000), ] #only accept answers in range of -1000 < x < 1000

list_vsl_id <- unique(mean_table$id)

for(id in list_vsl_id){
  mean_rt<-append(mean_rt,round(mean(mean_table$rt_col[mean_table$id==id]),digits=3))
  # normalize each participant's RT
  mean_table$rt_col[mean_table$id==id] = scale(mean_table$rt_col[mean_table$id==id])
  rt_slope <-append(rt_slope,round(summary(lm(mean_table$rt_col[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  hit_rate<-append(hit_rate,round(sum(!is.na(mean_table$rt_col[mean_table$id==id]))/total_vsl_trial,digits =2))
  miss_rate<-append(miss_rate,round(sum(fam_trial$rt_col[fam_trial$id==id]==-1)/total_vsl_trial,digits=2))
  correct_rejection <- append(correct_rejection, round(sum(fam_block$rt[fam_block$par_id==id]==-1 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/264,digits=3)) #264 is the total number of stimuli in the familiarization block
  false_alarm <- append(false_alarm, round(sum(fam_block$rt[fam_block$par_id==id]!=-1 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/264,digits=3))
}

subj_table <- data.frame(list_vsl_id,mean_rt, rt_slope,hit_rate, miss_rate,correct_rejection,false_alarm)
dprime<-NULL
for (i in seq(from=1,to=length(subj_table$list_vsl_id),by=1)){dprime<-append(dprime,qnorm(subj_table[i,]$hit_rate-0.00000001)-qnorm(subj_table[i,]$false_alarm+0.000000001))} #minus 0.000000001 to avoid perfect hit rate
subj_table$dprime <- dprime

#colnames(subj_table) <- c("VSL_ID","mean_rt", "rt_slope","hit", "miss","corr_rejection","false_alarm","dprime")
#print(kable(subj_table,format = "pandoc"))

group <- NULL
for (i in seq(from=1,to=length(subj_table$list_vsl_id),by=1))
    {if (subj_table[i,]$list_vsl_id %in% TYP)
    {group[i]<-"TYP"}
    else if (subj_table[i,]$list_vsl_id %in% DD)
    {group[i] <- "DD"}}
subj_table$group <- group

return(mean_table)
}

get_subj_visual <- function(data)
{
rt_col <- NULL
id <- NULL
trial <- NULL
target <- NULL
group_cond <- NULL

row_number <- which(vsl$targ==vsl$stimulus) #extract rows in which stimuli match with target
for (i in row_number){
        rt_col <- append(rt_col,vsl[i,][,"rt"])
        trial <- append(trial,vsl[i,][,"trial_index"])
        id <- append(id,vsl[i,]$par_id)
        group_cond <- append(group_cond,vsl[i,]$group)
    if (vsl[i-1,][,"rt"]!=-1){
        rt_col[(match(i,row_number))] <- -(1000-vsl[i-1,][,"rt"])
    }}

rt_df1 <- data.frame(trial,rt_col,id,group_cond) 
#NOTE: Depending on your version of R and your setting, the lines below may run inaccurately. You can check type rt_df1 after running this line to check if it returns a correct data frame. If not, run these two lines instead: 
#rt_df1 <- data.frame(unlist(trial),unlist(rt_col),id,group_cond) 
#colnames(rt_df1) <- c("trial","rt_col","id","group_cond")

fam_block <- vsl[which(vsl$trial_index<=300 & vsl$trial_index>=12),] #the familiarization block starts with index number 13 and ends with index 300
fam_trial <- rt_df1[which(rt_df1$trial<=300 & rt_df1$trial>=12), ]
reindex <- rep(1:total_vsl_trial,total_participant)
fam_trial$reindex <- reindex
fam_trial <- fam_trial[which(!is.na(fam_trial$group_cond)),]

hit_rate <- NULL
miss_rate <- NULL
correct_rejection <- NULL
false_alarm <- NULL
mean_rt <- NULL
rt_slope <- NULL
rt_slope_scale <- NULL
mean_table <- fam_trial[which(fam_trial$rt_col!=-1 & fam_trial$rt_col<1000 & fam_trial$rt_col>-1000), ] #only accept answers in range of -1000 < x < 1000

list_vsl_id <- unique(mean_table$id)

for(id in list_vsl_id){
  mean_rt<-append(mean_rt,round(mean(mean_table$rt_col[mean_table$id==id]),digits=3))
  mean_table$rt_col_scale[mean_table$id==id]<-scale(mean_table$rt_col[mean_table$id==id])
  rt_slope <-append(rt_slope,round(summary(lm(mean_table$rt_col[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  rt_slope_scale <-append(rt_slope_scale,round(summary(lm(mean_table$rt_col_scale[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  hit_rate<-append(hit_rate,round(sum(!is.na(mean_table$rt_col[mean_table$id==id]))/total_vsl_trial,digits =2))
  miss_rate<-append(miss_rate,round(sum(fam_trial$rt_col[fam_trial$id==id]==-1)/total_vsl_trial,digits=2))
  correct_rejection <- append(correct_rejection, round(sum(fam_block$rt[fam_block$par_id==id]==-1 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/264,digits=3)) #264 is the total number of stimuli in the familiarization block
  false_alarm <- append(false_alarm, round(sum(fam_block$rt[fam_block$par_id==id]!=-1 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/264,digits=3))
}

subj_table <- data.frame(list_vsl_id,mean_rt, rt_slope,rt_slope_scale,hit_rate, miss_rate,correct_rejection,false_alarm)
dprime<-NULL
for (i in seq(from=1,to=length(subj_table$list_vsl_id),by=1)){dprime<-append(dprime,qnorm(subj_table[i,]$hit_rate-0.00000001)-qnorm(subj_table[i,]$false_alarm+0.000000001))} #minus 0.000000001 to avoid perfect hit rate
subj_table$dprime <- dprime

#colnames(subj_table) <- c("VSL_ID","mean_rt", "rt_slope","hit", "miss","corr_rejection","false_alarm","dprime")
#print(kable(subj_table,format = "pandoc"))

group <- NULL
for (i in seq(from=1,to=length(subj_table$list_vsl_id),by=1))
    {if (subj_table[i,]$list_vsl_id %in% TYP)
    {group[i]<-"TYP"}
    else if (subj_table[i,]$list_vsl_id %in% DD)
    {group[i] <- "DD"}}
subj_table$group <- group

return(subj_table)
}
```

* Test the group difference in VSL
```{r,echo=FALSE,warning=FALSE}
fam_trial_vsl <- compute_visual()
subj_table_vsl <- get_subj_visual()
fam_trial_vsl_scale <- compute_visual_scale()
colnames(fam_trial_vsl)[3]="PartID"
colnames(fam_trial_vsl)[4]="Subgroup"
colnames(fam_trial_vsl_scale)[3]="PartID"
colnames(fam_trial_vsl_scale)[4]="Subgroup"
colnames(subj_table_vsl)[1]="PartID"
colnames(subj_table_vsl)[10]="Subgroup"
write.csv(fam_trial_vsl_scale,"vsl_rt_scale_trial.csv")
write.csv(fam_trial_vsl,"vsl_rt_trial.csv")
write.csv(subj_table_vsl,"vsl_rt_subj_table.csv")
```
* VSL RT summary stats (mean +/ sd)
```{r,echo=FALSE,warning=FALSE}
data<-as_tibble(subj_table_vsl)
data %>%
  group_by(Subgroup) %>%
  dplyr::summarise(
          count = n(),
          rt = qwraps2::mean_sd(mean_rt),
          slope = qwraps2::mean_sd(rt_slope),
          d_prime = qwraps2::mean_sd(dprime)
          )
```
* The DD group had a faster RT acceleration than the TYP group tested by linear regression models
```{r,echo=FALSE,warning=FALSE}
model1 <- lm(rt_col~reindex*Subgroup,data=fam_trial_vsl)
print(summary(model1))
model1_scale <- lm(rt_col~reindex*Subgroup,data=fam_trial_vsl_scale)
print(summary(model1_scale))
```
* marginal results with the raw RT data and significant results (same as linear regression) with the scaled data tested by lmer.
```{r,echo=FALSE,warning=FALSE}
library(lmerTest)
model2 <- lmer(rt_col~Subgroup*reindex + (1|PartID)+(0+reindex|PartID),data=fam_trial_vsl)
print(summary(model2))
model2_scale <- lmer(rt_col~Subgroup*reindex + (1|PartID)+(0+reindex|PartID),data=fam_trial_vsl_scale)
print(summary(model2_scale))
```
##Plot of VSL RT
### RT as the function of Target repetition
```{r,echo=FALSE}
vsl_rt_plot<-dplyr::summarise(group_by(fam_trial_vsl,Subgroup,reindex), n = n(),
                         mean=mean(rt_col,na.rm = T), sd=sd(rt_col,na.rm = T),se = sd/sqrt(n))

ggplot(data = vsl_rt_plot, aes(x=reindex, y=mean, color = Subgroup))+
  geom_line() +geom_point()  +
  scale_color_manual(values=c('red','blue'))+
  geom_errorbar(aes(ymin=mean-se,ymax=mean+se),
                 width=.1,  size=0.5)+
  scale_x_continuous(breaks=seq(2,24,2))+
  #scale_y_continuous(limits = c(0.2, 0.5))+
  theme(
    axis.title = element_text(family = "Trebuchet MS", size = 20),
    legend.key.size = unit(1, "cm"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15))  + 
  labs(x = "Trials", y = "Response Time (ms)") +
  theme(panel.background = element_rect(fill = "white", colour = "grey50")) + 
  theme(axis.line = element_line(arrow = arrow(angle = 15, length = unit(.15,"inches"),type = "closed")))
```

<!-- ### Boxplot of the first half of the trials is significantly greater than the latter half of the trial -->
<!-- ```{r,echo=FALSE} -->
<!-- par(mfrow=c(1,2)) -->
<!-- boxplot(fam_trial_vsl_scale$rt_col[fam_trial_vsl_scale$reindex<total_vsl_trial/2], main="RT - first half of the trials",col="deepskyblue4",ylim=c(-4,4)) -->
<!-- boxplot(fam_trial_vsl_scale$rt_col[fam_trial_vsl_scale$reindex>total_vsl_trial/2], main="RT - latter half of the trials",col="deepskyblue4",ylim=c(-4,4)) -->
<!-- ``` -->

### plot mean RT slope across the two groups
* mean RT slope
```{r,echo=FALSE,warning=FALSE}
cbbPalette <- c("#000000","#000000")
ggplot() +
  geom_bar(aes(x = Subgroup,y = rt_slope,fill = Subgroup),data=subj_table_vsl,colour = '#000000',fun.data = mean_sdl,fun.args = list(mult = 1),stat = 'summary',position = position_dodge(width = 0.9)) +
  theme_classic(base_size = 18.0) +
  ylab(label = 'Response Time Slope (ms/Trial)') +
  xlab(label = 'Group') +
  #coord_cartesian(ylim = c(0.3,1)) +
  geom_errorbar(aes(y = rt_slope, x = Subgroup),data=subj_table_vsl,size = 0.3,width = 0.2,fun.y = function(x) mean(x),fun.ymin = function(x) mean(x) - sd(x)/sqrt(length(x)),fun.ymax = function(x) mean(x) + sd(x)/sqrt(length(x)) ,stat = 'summary')+
  geom_beeswarm(aes(x = Subgroup,y = rt_slope, colour = Subgroup),data=subj_table_vsl,dodge.width=0.9,cex=2.5) +
  scale_fill_brewer(palette = 'Set1') + 
  scale_color_manual(values=cbbPalette)
```

* mean RT slope scaled
```{r,echo=FALSE,warning=FALSE}
ggplot() +
  geom_bar(aes(x = Subgroup,y = rt_slope_scale,fill = Subgroup),data=subj_table_vsl,colour = '#000000',fun.data = mean_sdl,fun.args = list(mult = 1),stat = 'summary',position = position_dodge(width = 0.9)) +
  theme_classic(base_size = 18.0) +
  ylab(label = 'Scaled Response Time Slope\n(au/trial)') +
  xlab(label = 'Group') +
  #coord_cartesian(ylim = c(0.3,1)) +
  geom_errorbar(aes(y = rt_slope_scale, x = Subgroup),data=subj_table_vsl,size = 0.3,width = 0.2,fun.y = function(x) mean(x),fun.ymin = function(x) mean(x) - sd(x)/sqrt(length(x)),fun.ymax = function(x) mean(x) + sd(x)/sqrt(length(x)) ,stat = 'summary')+
  geom_beeswarm(aes(x = Subgroup,y = rt_slope_scale, colour = Subgroup),data=subj_table_vsl,dodge.width=0.9,cex=2.5) +
  scale_fill_brewer(palette = 'Set1') + 
  scale_color_manual(values=cbbPalette)
```

#Compute RT for TSL
* The two groups are not different in the target detection task
* Neither group showed a significant negative RT slope.
```{r,echo=FALSE,warning=FALSE}
compute_aud <- function(data)
{
rt_col <- NULL
id <- NULL
trial <- NULL
target <- NULL
group_cond <- NULL
row_number <- which(tsl$targ==tsl$stimulus)
for (i in row_number){
  #the audio plays 100ms after the trial begins, and the trial lasts 480ms, hence the number
        if (tsl[i,]$rt > 0){rt_col <- append(rt_col,tsl[i,][,"rt"]-100)} 
        if (tsl[i,]$rt < 0){rt_col <- append(rt_col,100-tsl[i,][,"rt"]-100)}
        trial <- append(trial,tsl[i,][,"trial_index"])
        id <- append(id,tsl[i,]$par_id)
         group_cond <- append(group_cond,tsl[i,]$group)
   if (tsl[i+1,][,"rt"]!=-1000 & tsl[i+1,][,"rt"]<0){
        rt_col[(match(i,row_number))] <- 380-tsl[i+1,][,"rt"]}
    
    if (tsl[i-1,][,"rt"]>0){
        rt_col[(match(i,row_number))] <- 480-tsl[i-1,][,"rt"]}
   if (tsl[i+1,][,"rt"]!=-1000 & tsl[i+1,][,"rt"]>0){
    rt_col[(match(i,row_number))] <- 580+tsl[i+1,][,"rt"]}
         
    }

 
rt_df1 <- data.frame(trial,rt_col,id,group_cond)
fam_block <- tsl[which(tsl$trial_index<603 & tsl$trial_index>26),] #fam block in tsl starts at index 27 and ends at index 602
fam_trial <- rt_df1[which(rt_df1$trial<603 & rt_df1$trial>26), ]

reindex <- rep(1:total_tsl_trial,total_participant)
fam_trial$reindex <- reindex
fam_trial <- fam_trial[which(!is.na(fam_trial$group_cond)),]

mean_table <- fam_trial[which(fam_trial$rt_col!=-1000),]
mean_table <- fam_trial[which(fam_trial$rt_col<960 & fam_trial$rt_col>-960), ] #only accepts answer in range of -380 < x < 580 (one stimulus before and one stimulus after the target)
hit_rate <- NULL
miss_rate <- NULL
correct_rejection <- NULL
false_alarm <- NULL
mean_rt <- NULL
rt_slope <- NULL
list_tsl_id <- unique(mean_table$id)

for(id in list_tsl_id){
  mean_rt<-append(mean_rt,round(mean(mean_table$rt_col[mean_table$id==id]),digits=3))
  rt_slope <-append(rt_slope,round(summary(lm(mean_table$rt_col[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  hit_rate<-append(hit_rate,round(sum(mean_table$rt_col[mean_table$id==id]!=-1000)/total_tsl_trial,digits =2))
  miss_rate<-append(miss_rate,round(sum(fam_trial$rt_col[fam_trial$id==id]==-1000 | fam_trial$rt_col[fam_trial$id==id]<=-480 | fam_trial$rt_col[fam_trial$id==id]>960)/total_tsl_trial,digits=2))
  correct_rejection <- append(correct_rejection, round(sum(fam_block$rt[fam_block$par_id==id]==-1000 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/528,digits=2)) #528 is the total number of stimuli in the fam block
  false_alarm <- append(false_alarm, round(sum(fam_block$rt[fam_block$par_id==id]!=-1000 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/528,digits=2))
}


subj_table <- data.frame(list_tsl_id,mean_rt, rt_slope,hit_rate, miss_rate,correct_rejection,false_alarm)
dprime<-NULL
for (i in seq(from=1,to=length(subj_table$list_tsl_id),by=1)){dprime<-append(dprime,qnorm(subj_table[i,]$hit_rate-0.00000001)-qnorm(subj_table[i,]$false_alarm))}
subj_table$dprime <- dprime

#colnames(subj_table) <- c("TSL_ID","mean_rt", "rt_slope","hit", "miss","corr_rejection","false_alarm","dprime")

#print(kable(subj_table))
group <- NULL
for (i in seq(from=1,to=length(subj_table$list_tsl_id),by=1))
    {if (subj_table[i,]$list_tsl_id %in% TYP)
    {group[i]<-"TYP"}
    else if (subj_table[i,]$list_tsl_id %in% DD)
    {group[i] <- "DD"}}
subj_table$group <- group
model3 <- wilcox.test(dprime~group,data=subj_table)
print(model3)
model4 <- wilcox.test(mean_rt~group,data=subj_table)
print(model4)
print(t.test(subj_table$rt_slope[subj_table$group=="DD"],mu=0,alternative="less"))
print(t.test(subj_table$rt_slope[subj_table$group=="TYP"],mu=0,alternative="less"))
return(mean_table)
}

compute_aud_scale <- function(data)
{
rt_col <- NULL
id <- NULL
trial <- NULL
target <- NULL
group_cond <- NULL
row_number <- which(tsl$targ==tsl$stimulus)
for (i in row_number){
  #the audio plays 100ms after the trial begins, and the trial lasts 480ms, hence the number
        if (tsl[i,]$rt > 0){rt_col <- append(rt_col,tsl[i,][,"rt"]-100)} 
        if (tsl[i,]$rt < 0){rt_col <- append(rt_col,100-tsl[i,][,"rt"]-100)}
        trial <- append(trial,tsl[i,][,"trial_index"])
        id <- append(id,tsl[i,]$par_id)
         group_cond <- append(group_cond,tsl[i,]$group)
   if (tsl[i+1,][,"rt"]!=-1000 & tsl[i+1,][,"rt"]<0){
        rt_col[(match(i,row_number))] <- 380-tsl[i+1,][,"rt"]}
    
    if (tsl[i-1,][,"rt"]>0){
        rt_col[(match(i,row_number))] <- 480-tsl[i-1,][,"rt"]}
   if (tsl[i+1,][,"rt"]!=-1000 & tsl[i+1,][,"rt"]>0){
    rt_col[(match(i,row_number))] <- 580+tsl[i+1,][,"rt"]}
         
    }

 
rt_df1 <- data.frame(trial,rt_col,id,group_cond)
fam_block <- tsl[which(tsl$trial_index<603 & tsl$trial_index>26),] #fam block in tsl starts at index 27 and ends at index 602
fam_trial <- rt_df1[which(rt_df1$trial<603 & rt_df1$trial>26), ]

reindex <- rep(1:total_tsl_trial,total_participant)
fam_trial$reindex <- reindex
fam_trial <- fam_trial[which(!is.na(fam_trial$group_cond)),]

mean_table <- fam_trial[which(fam_trial$rt_col!=-1000),]
mean_table <- fam_trial[which(fam_trial$rt_col<960 & fam_trial$rt_col>-960), ] #only accepts answer in range of -380 < x < 580 (one stimulus before and one stimulus after the target)
hit_rate <- NULL
miss_rate <- NULL
correct_rejection <- NULL
false_alarm <- NULL
mean_rt <- NULL
rt_slope <- NULL
list_tsl_id <- unique(mean_table$id)

for(id in list_tsl_id){
  mean_rt<-append(mean_rt,round(mean(mean_table$rt_col[mean_table$id==id]),digits=3))
  mean_table$rt_col[mean_table$id==id] = scale(mean_table$rt_col[mean_table$id==id])
  rt_slope <-append(rt_slope,round(summary(lm(mean_table$rt_col[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  hit_rate<-append(hit_rate,round(sum(mean_table$rt_col[mean_table$id==id]!=-1000)/total_tsl_trial,digits =2))
  miss_rate<-append(miss_rate,round(sum(fam_trial$rt_col[fam_trial$id==id]==-1000 | fam_trial$rt_col[fam_trial$id==id]<=-480 | fam_trial$rt_col[fam_trial$id==id]>960)/total_tsl_trial,digits=2))
  correct_rejection <- append(correct_rejection, round(sum(fam_block$rt[fam_block$par_id==id]==-1000 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/528,digits=2)) #528 is the total number of stimuli in the fam block
  false_alarm <- append(false_alarm, round(sum(fam_block$rt[fam_block$par_id==id]!=-1000 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/528,digits=2))
}


subj_table <- data.frame(list_tsl_id,mean_rt, rt_slope,hit_rate, miss_rate,correct_rejection,false_alarm)
dprime<-NULL
for (i in seq(from=1,to=length(subj_table$list_tsl_id),by=1)){dprime<-append(dprime,qnorm(subj_table[i,]$hit_rate-0.00000001)-qnorm(subj_table[i,]$false_alarm))}
subj_table$dprime <- dprime

#colnames(subj_table) <- c("TSL_ID","mean_rt", "rt_slope","hit", "miss","corr_rejection","false_alarm","dprime")
#print(kable(subj_table))
group <- NULL
for (i in seq(from=1,to=length(subj_table$list_tsl_id),by=1))
    {if (subj_table[i,]$list_tsl_id %in% TYP)
    {group[i]<-"TYP"}
    else if (subj_table[i,]$list_tsl_id %in% DD)
    {group[i] <- "DD"}}
subj_table$group <- group
return(mean_table)
}

get_subj_aud <- function(data)
{
rt_col <- NULL
id <- NULL
trial <- NULL
target <- NULL
group_cond <- NULL
row_number <- which(tsl$targ==tsl$stimulus)
for (i in row_number){
  #the audio plays 100ms after the trial begins, and the trial lasts 480ms, hence the number
        if (tsl[i,]$rt > 0){rt_col <- append(rt_col,tsl[i,][,"rt"]-100)} 
        if (tsl[i,]$rt < 0){rt_col <- append(rt_col,100-tsl[i,][,"rt"]-100)}
        trial <- append(trial,tsl[i,][,"trial_index"])
        id <- append(id,tsl[i,]$par_id)
         group_cond <- append(group_cond,tsl[i,]$group)
   if (tsl[i+1,][,"rt"]!=-1000 & tsl[i+1,][,"rt"]<0){
        rt_col[(match(i,row_number))] <- 380-tsl[i+1,][,"rt"]}
    
    if (tsl[i-1,][,"rt"]>0){
        rt_col[(match(i,row_number))] <- 480-tsl[i-1,][,"rt"]}
   if (tsl[i+1,][,"rt"]!=-1000 & tsl[i+1,][,"rt"]>0){
    rt_col[(match(i,row_number))] <- 580+tsl[i+1,][,"rt"]}
         
    }

 
rt_df1 <- data.frame(trial,rt_col,id,group_cond)
fam_block <- tsl[which(tsl$trial_index<603 & tsl$trial_index>26),] #fam block in tsl starts at index 27 and ends at index 602
fam_trial <- rt_df1[which(rt_df1$trial<603 & rt_df1$trial>26), ]

reindex <- rep(1:total_tsl_trial,total_participant)
fam_trial$reindex <- reindex
fam_trial <- fam_trial[which(!is.na(fam_trial$group_cond)),]

mean_table <- fam_trial[which(fam_trial$rt_col!=-1000),]
mean_table <- fam_trial[which(fam_trial$rt_col<960 & fam_trial$rt_col>-960), ] #only accepts answer in range of -380 < x < 580 (one stimulus before and one stimulus after the target)
hit_rate <- NULL
miss_rate <- NULL
correct_rejection <- NULL
false_alarm <- NULL
mean_rt <- NULL
rt_slope <- NULL
rt_slope_scale <- NULL
list_tsl_id <- unique(mean_table$id)

for(id in list_tsl_id){
  mean_rt<-append(mean_rt,round(mean(mean_table$rt_col[mean_table$id==id]),digits=3))
  mean_table$rt_col_scale[mean_table$id==id]=scale(mean_table$rt_col[mean_table$id==id])
  rt_slope <-append(rt_slope,round(summary(lm(mean_table$rt_col[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  rt_slope_scale <-append(rt_slope_scale,round(summary(lm(mean_table$rt_col_scale[mean_table$id==id]~mean_table$reindex[mean_table$id==id]))$coefficient[2,1],digits=3))
  hit_rate<-append(hit_rate,round(sum(mean_table$rt_col[mean_table$id==id]!=-1000)/total_tsl_trial,digits =2))
  miss_rate<-append(miss_rate,round(sum(fam_trial$rt_col[fam_trial$id==id]==-1000 | fam_trial$rt_col[fam_trial$id==id]<=-480 | fam_trial$rt_col[fam_trial$id==id]>960)/total_tsl_trial,digits=2))
  correct_rejection <- append(correct_rejection, round(sum(fam_block$rt[fam_block$par_id==id]==-1000 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/528,digits=2)) #528 is the total number of stimuli in the fam block
  false_alarm <- append(false_alarm, round(sum(fam_block$rt[fam_block$par_id==id]!=-1000 & fam_block$targ[fam_block$par_id==id]!=fam_block$stimulus[fam_block$par_id==id])/528,digits=2))
}


subj_table <- data.frame(list_tsl_id,mean_rt, rt_slope,rt_slope_scale,hit_rate, miss_rate,correct_rejection,false_alarm)
dprime<-NULL
for (i in seq(from=1,to=length(subj_table$list_tsl_id),by=1)){dprime<-append(dprime,qnorm(subj_table[i,]$hit_rate-0.00000001)-qnorm(subj_table[i,]$false_alarm))}
subj_table$dprime <- dprime

#colnames(subj_table) <- c("TSL_ID","mean_rt", "rt_slope","hit", "miss","corr_rejection","false_alarm","dprime")
#print(kable(subj_table))
group <- NULL
for (i in seq(from=1,to=length(subj_table$list_tsl_id),by=1))
    {if (subj_table[i,]$list_tsl_id %in% TYP)
    {group[i]<-"TYP"}
    else if (subj_table[i,]$list_tsl_id %in% DD)
    {group[i] <- "DD"}}
subj_table$group <- group
return(subj_table)
}
```

```{r,echo=FALSE,warning=FALSE}
fam_trial_tsl <- compute_aud()
fam_trial_tsl_scale <- compute_aud_scale()
subj_table_tsl <- get_subj_aud()
colnames(fam_trial_tsl)[3]="PartID"
colnames(fam_trial_tsl)[4]="Subgroup"
colnames(fam_trial_tsl_scale)[3]="PartID"
colnames(fam_trial_tsl_scale)[4]="Subgroup"
colnames(subj_table_tsl)[1]="PartID"
colnames(subj_table_tsl)[10]="Subgroup"
write.csv(fam_trial_vsl_scale,"tsl_rt_scale_trial.csv")
write.csv(fam_trial_vsl,"tsl_rt_trial.csv")
write.csv(subj_table_vsl,"tsl_rt_subj_table.csv")
```
* TSL RT summary (mean +/- sd)
```{r,echo=FALSE,warning=FALSE}
data<-as_tibble(subj_table_tsl)
data %>%
  group_by(Subgroup) %>%
  dplyr::summarise(
          count = n(),
          rt = qwraps2::mean_sd(mean_rt),
          slope = qwraps2::mean_sd(rt_slope),
          d_prime = qwraps2::mean_sd(dprime),
          hits = qwraps2::mean_sd(hit_rate)
          )
```

* remove outliers who have hit rate lower than and equal to 0.25 (remaining participant: 14 DD and 18 TYP)
* participants removed from analysis: ABCD_1705 ABCD_1720 ABCD_1747 ABCD_1767 ABCD_1783 ABCD_1788 ABCD_1709 ABCD_1724 
```{r,echo=FALSE,warning=FALSE}
usable_tsl_rt<-subj_table_tsl[subj_table_tsl$hit_rate>0.25,]$PartID
subj_table_tsl_usable <-subset(subj_table_tsl,PartID %in% usable_tsl_rt)
data<-as_tibble(subj_table_tsl_usable)
data %>%
  group_by(Subgroup) %>%
  dplyr::summarise(
          count = n(),
          rt = qwraps2::mean_sd(mean_rt),
          slope = qwraps2::mean_sd(rt_slope),
          d_prime = qwraps2::mean_sd(dprime),
          hits = qwraps2::mean_sd(hit_rate)
          )
```

* the two groups are not different in RT slope.
```{r,echo=FALSE,warning=FALSE}
t.test(dprime~Subgroup,data=subj_table_tsl_usable)
t.test(rt_slope~Subgroup,data=subj_table_tsl_usable)
fam_trial_tsl_usable <-subset(fam_trial_tsl,PartID %in% usable_tsl_rt)
fam_trial_tsl_usable_s <-subset(fam_trial_tsl_scale,PartID %in% usable_tsl_rt)
model1 <- lm(rt_col~reindex*Subgroup,data=fam_trial_tsl_usable)
print(summary(model1))
model1_scale <-lm(rt_col~reindex*Subgroup,data=fam_trial_tsl_usable_s)
print(summary(model1_scale))
model2 <- lmer(rt_col~reindex*Subgroup+(1|PartID)+(0+reindex|PartID),data=fam_trial_tsl_usable)
print(summary(model2))
model2_scale <- lmer(rt_col~reindex*Subgroup+(1|PartID)+(0+reindex|PartID),data=fam_trial_tsl_usable_s)
print(summary(model2_scale))
```

##Plot of TSL RT
### RT as the function of Target repetition
```{r,echo=FALSE}
tsl_rt_plot<-dplyr::summarise(group_by(fam_trial_tsl,Subgroup,reindex), n = n(),
                         mean=mean(rt_col,na.rm = T), sd=sd(rt_col,na.rm = T),se = sd/sqrt(n))

ggplot(data = tsl_rt_plot, aes(x=reindex, y=mean, color = Subgroup))+
  geom_line() +geom_point()  +
  scale_color_manual(values=c('red','blue'))+
  geom_errorbar(aes(ymin=mean-se,ymax=mean+se),
                 width=.1,  size=0.5)+
  scale_x_continuous(breaks=seq(4,48,4))+
  #scale_y_continuous(limits = c(0.2, 0.5))+
  theme(
    axis.title = element_text(family = "Trebuchet MS", size = 20),
    legend.key.size = unit(1, "cm"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15))  + 
  labs(x = "Trials", y = "Response Time (ms)") +
  theme(panel.background = element_rect(fill = "white", colour = "grey50")) + 
  theme(axis.line = element_line(arrow = arrow(angle = 15, length = unit(.15,"inches"),type = "closed")))
```
### plot mean RT slope across the two groups
* mean RT slope
```{r,echo=FALSE}
cbbPalette <- c("#000000","#000000")
ggplot() +
  geom_bar(aes(x = Subgroup,y = rt_slope,fill = Subgroup),data=subj_table_tsl_usable,colour = '#000000',fun.data = mean_sdl,fun.args = list(mult = 1),stat = 'summary',position = position_dodge(width = 0.9)) +
  theme_classic(base_size = 18.0) +
  ylab(label = 'Response Time Slope (ms/Trial)') +
  xlab(label = 'Group') +
  #coord_cartesian(ylim = c(0.3,1)) +
  geom_errorbar(aes(y = rt_slope, x = Subgroup),data=subj_table_tsl_usable,size = 0.3,width = 0.2,fun.y = function(x) mean(x),fun.ymin = function(x) mean(x) - sd(x)/sqrt(length(x)),fun.ymax = function(x) mean(x) + sd(x)/sqrt(length(x)) ,stat = 'summary')+
  geom_beeswarm(aes(x = Subgroup,y = rt_slope, colour = Subgroup),data=subj_table_tsl_usable,dodge.width=0.9,cex=2.5) +
  scale_fill_brewer(palette = 'Set1') + 
  scale_color_manual(values=cbbPalette)
```

* mean RT slope scaled
```{r,echo=FALSE}
ggplot() +
  geom_bar(aes(x = Subgroup,y = rt_slope_scale,fill = Subgroup),data=subj_table_tsl_usable,colour = '#000000',fun.data = mean_sdl,fun.args = list(mult = 1),stat = 'summary',position = position_dodge(width = 0.9)) +
  theme_classic(base_size = 18.0) +
  ylab(label = 'Scaled Response Time Slope\n(au/trial)') +
  xlab(label = 'Group') +
  #coord_cartesian(ylim = c(0.3,1)) +
  geom_errorbar(aes(y = rt_slope_scale, x = Subgroup),data=subj_table_tsl_usable,size = 0.3,width = 0.2,fun.y = function(x) mean(x),fun.ymin = function(x) mean(x) - sd(x)/sqrt(length(x)),fun.ymax = function(x) mean(x) + sd(x)/sqrt(length(x)) ,stat = 'summary')+
  geom_beeswarm(aes(x = Subgroup,y = rt_slope_scale, colour = Subgroup),data=subj_table_tsl_usable,dodge.width=0.9,cex=2.5) +
  scale_fill_brewer(palette = 'Set1') + 
  scale_color_manual(values=cbbPalette)
```

## Combine slope data of both tasks
```{r,echo=FALSE,warning=FALSE}
colnames(subj_table_tsl_usable)[1]="subj"
colnames(subj_table_vsl)[1]="subj"
subj_table_tsl_usable$task = "Auditory"
subj_table_vsl$task = "Visual"
all_subj_slope = rbind(subj_table_vsl,subj_table_tsl_usable)
fam_trial_vsl_scale$task="Visual"
fam_trial_tsl_usable_s$task="Auditory"
all_fam_trials = rbind(fam_trial_vsl_scale,fam_trial_tsl_usable_s)
```

### check interactions between task and group, using scaled RT: No interaction; anova showed marginal main effect of group (TYP is slower)
```{r,echo=FALSE,warning=FALSE}
all_subj_slope$tasknum=""
for (id in all_subj_slope$subj) {
  all_subj_slope[all_subj_slope$subj==id,]$tasknum = nrow(all_subj_slope[all_subj_slope$subj==id,])
}
all_subj_slope_complete = subset(all_subj_slope,tasknum==2)
model_rt <- aov(rt_slope_scale~task*Subgroup+mean_rt+Error(subj/task),data=all_subj_slope_complete) # controlling for mean rt.
print(summary(model_rt))
model_rt_lmer <- lmer(rt_col~task*Subgroup+(1+task|PartID)+(1|reindex),data=all_fam_trials)
print(summary(model_rt_lmer))
```

* plot both tasks (scaled RT)
```{r,echo=FALSE}
stat.test <- all_subj_slope %>%
  group_by(task) %>%
  tukey_hsd(rt_slope_scale~Subgroup)
stat.test
```
```{r,echo=FALSE}
ggplot() +
  geom_bar(aes(x = Subgroup,y = rt_slope_scale,fill = Subgroup),data=all_subj_slope,colour = '#000000',fun.data = mean_sdl,fun.args = list(mult = 1),stat = 'summary',position = position_dodge(width = 0.9)) +
  theme_classic(base_size = 18.0) +
  ylab(label = 'Scaled Response Time Slope\n(au/trial)') +
  xlab(label = 'Group') +
  #coord_cartesian(ylim = c(0.3,1)) +
  geom_errorbar(aes(y = rt_slope_scale, x = Subgroup),data=all_subj_slope,size = 0.3,width = 0.2,fun.y = function(x) mean(x),fun.ymin = function(x) mean(x) - sd(x)/sqrt(length(x)),fun.ymax = function(x) mean(x) + sd(x)/sqrt(length(x)) ,stat = 'summary')+
  geom_beeswarm(aes(x = Subgroup,y = rt_slope_scale, colour = Subgroup),data=all_subj_slope,dodge.width=0.9,cex=2.5) +
  facet_wrap(task~.) +
  scale_fill_brewer(palette = 'Set1') + 
  scale_color_manual(values=cbbPalette)
```

#Compute accuracy
```{r,echo=FALSE,warning=FALSE}
vsl_acc <- vsl[which(vsl$trial_index<614 & vsl$trial_index>309),] #the test block starts and ends with this index
tsl_acc <- tsl[which(tsl$trial_index<831 & tsl$trial_index>608),]
vsl_cond <- NULL
for (i in seq(from=1,to=length(vsl$cond),by=length_vsl)){vsl_cond<-append(vsl_cond,as.character(vsl[i,]$cond))}
tsl_cond <- NULL
for (i in seq(from=1,to=length(tsl$cond),by=length_tsl)){tsl_cond<-append(tsl_cond,as.character(tsl[i,]$cond))}

ans <- NULL
keyv <- NULL
subj <- NULL
group<- NULL
cond<-NULL

#Extract the response for the 2AFC task
#vsl acc
row_numberv <- which(vsl_acc$key_press != -1 & vsl_acc$stimulus=="")
  for (i in row_numberv){
    ans<-append(ans,vsl_acc[i,]$key_press)
    subj <- append(subj,vsl_acc[i,]$par_id)
    cond <- append(cond,vsl_acc[i,]$cond)
    group <- append(group,vsl_acc[i,]$group)
  }
  
vsl_accuracy <- data.frame(ans,subj,cond,group)

#tsl acc
ans <- NULL
keyt <- NULL
subj <- NULL
group<- NULL
cond<-NULL

row_numbert <- which(tsl_acc$key_press != -1 & (tsl_acc$trial_index-613)%%7==0) #since there is no stimuli recorded for the test block of tsl, we can only get the correct answer by counting the index. The test starts at 613 and the response begins every 7 index after that
  for (i in row_numbert){
    ans<-append(ans,tsl_acc[i,]$key_press)
    subj <- append(subj,tsl_acc[i,]$par_id)
    cond <- append(cond,tsl_acc[i,]$cond)
    group <- append(group,tsl_acc[i,]$group)
  }
 
tsl_accuracy <- data.frame(ans,subj,cond,group)

#Match the language condition with the correct answer key
for(cond in vsl_cond){
    if (cond=="lang1"){keyv<-append(keyv,language_1)}
    else if (cond=="lang2"){keyv<-append(keyv,language_2)}}

for(cond in tsl_cond){
    if (cond=="lang1"){keyt<-append(keyt,language_1)}
    else if (cond=="lang2"){keyt<-append(keyt,language_2)}}


vsl_accuracy$key <- keyv
tsl_accuracy$key <- keyt

#Substitute the key press (49,50) with the answer (1,2)
vsl_accuracy$ans <- gsub(50,2,vsl_accuracy$ans)
vsl_accuracy$ans <- gsub(49,1,vsl_accuracy$ans)

tsl_accuracy$ans <- gsub(37,1,tsl_accuracy$ans)
tsl_accuracy$ans <- gsub(39,2,tsl_accuracy$ans)

corr <- NULL
corrt <- NULL
trial <- NULL
trialt <- NULL

#Loop through, count the correct answer, and add trial number
for (i in seq(from=1,to=length(vsl_accuracy$ans),by=1)){
  corr<-append(corr,as.numeric(vsl_accuracy[i,]$ans==vsl_accuracy[i,]$key))
}

for(id in list_vsl_id){
  for (i in seq(from=1,to=length(vsl_accuracy$ans[vsl_accuracy$subj==id]),by=1)){
    trial <-append(trial,i)
  }
}

vsl_accuracy$corr <- corr
vsl_accuracy$trial <- trial
vsl_accuracy$task <- "Visual"

subj_corr <- NULL
for (id in list_vsl_id) {
  subj_corr <- append(subj_corr,round(sum(vsl_accuracy$corr[vsl_accuracy$subj==id])/total_test_trial,digits=3))
}
vsl_acc_table <- data.frame(list_vsl_id,subj_corr,vsl_cond)
vsl_acc_table$task <- "Visual"
vsl_acc_table$group<-""
vsl_acc_table[vsl_acc_table$list_vsl_id %in% DD,]$group = "DD"
vsl_acc_table[vsl_acc_table$list_vsl_id %in% TYP,]$group = "TYP"
colnames(vsl_acc_table)[1] = "PartID"
colnames(vsl_acc_table)[5] = "Subgroup"
colnames(vsl_acc_table)[3] = "language"
colnames(vsl_accuracy)[2] = "PartID"
colnames(vsl_accuracy)[4] = "Subgroup"

for (i in seq(from=1,to=length(tsl_accuracy$ans),by=1)){
  corrt<-append(corrt,as.numeric(tsl_accuracy[i,]$ans==tsl_accuracy[i,]$key))
}

for(id in list_tsl_id){
  for (i in seq(from=1,to=length(tsl_accuracy$ans[tsl_accuracy$subj==id]),by=1)){
    trialt <-append(trialt,i)
  }
}
tsl_accuracy$corr <- corrt
tsl_accuracy$trial <- trialt
tsl_accuracy$task <- "Auditory"

subj_corrt <- NULL
for (id in list_tsl_id) {
  subj_corrt <- append(subj_corrt,round(sum(tsl_accuracy$corr[tsl_accuracy$subj==id])/total_test_trial,digits=3))
}
tsl_acc_table <- data.frame(list_tsl_id,subj_corrt,tsl_cond)
tsl_acc_table$task <- "Auditory"
tsl_acc_table$group<-""
tsl_acc_table[tsl_acc_table$list_tsl_id %in% DD,]$group = "DD"
tsl_acc_table[tsl_acc_table$list_tsl_id %in% TYP,]$group = "TYP"
colnames(tsl_acc_table)[1] = "PartID"
colnames(tsl_acc_table)[5] = "Subgroup"
colnames(tsl_acc_table)[3] = "language"
colnames(tsl_acc_table)[2] = "subj_corr"
colnames(tsl_accuracy)[2] = "PartID"
colnames(tsl_accuracy)[4] = "Subgroup"
all_accuracy <- rbind(vsl_accuracy,tsl_accuracy)
all_acc_table <- rbind(vsl_acc_table,tsl_acc_table)
all_accuracy$key <- vapply(all_accuracy$key, paste, collapse = ", ", character(1L))
write.csv(all_accuracy,"all_sl_accuracy.csv")
write.csv(all_acc_table,"sl_acc_subj_table.csv")
```
## Accuracy Data Summary (mean +/- sd)
```{r,echo=FALSE,warning=FALSE}
data<-as_tibble(all_acc_table)
data %>%
  group_by(Subgroup,task) %>%
  dplyr::summarise(
          count = n(),
          accuracy = qwraps2::mean_sd(subj_corr)
          )
```
##Look into group performance between Dyl and Typ
### simple t test: both groups performed above chance for both tasks
```{r,echo=FALSE,warning=FALSE}
DD_acc_vsl <- NULL
DD_acc_tsl <- NULL
TYP_acc_vsl <- NULL
TYP_acc_tsl <- NULL

for(id in DD){
  DD_acc_vsl<- append(DD_acc_vsl,vsl_acc_table$subj_corr[vsl_acc_table$PartID==id])
  DD_acc_tsl<- append(DD_acc_tsl,tsl_acc_table$subj_corr[tsl_acc_table$PartID==id])
}

for(id in TYP){
  TYP_acc_vsl<- append(TYP_acc_vsl,vsl_acc_table$subj_corr[vsl_acc_table$PartID==id])
  TYP_acc_tsl<- append(TYP_acc_tsl,tsl_acc_table$subj_corr[tsl_acc_table$PartID==id])
}

t.test(DD_acc_vsl,mu=0.5,alternative = "greater")
t.test(DD_acc_tsl,mu=0.5,alternative = "greater")

t.test(TYP_acc_vsl,mu=0.5,alternative = "greater")
t.test(TYP_acc_tsl,mu=0.5,alternative = "greater")
```
### anova: marginal main effect of task and marginal interaction between task and group
```{r,echo=FALSE,warning=FALSE}
all_acc_table_complete = subset(all_acc_table,PartID!="ABCD_1708")
all_acc_table_complete = subset(all_acc_table_complete,PartID!="ABCD_1727")
model_acc <- aov(subj_corr~task*Subgroup+Error(PartID/task),data=all_acc_table_complete)
print(summary(model_acc))
```
### generalized linear effect modeling: main effect of task (visual > auditory); main effect of group (TYP > DD); marginal interaction between task and group 
```{r,echo=FALSE}
model_acc_lmer <- glmer(corr~task*Subgroup+(1+task|PartID)+(1|trial),data=all_accuracy,family="binomial")
print(summary(model_acc_lmer))
```
### generalized linear effect modeling within each task
```{r,echo=FALSE}
vsl_accuracy = subset(all_accuracy,task=="Visual")
tsl_accuracy = subset(all_accuracy,task=="Auditory")

model_vslacc_lmer <- glmer(corr~Subgroup+(1|PartID)+(1|trial),data=vsl_accuracy,family="binomial")
print(summary(model_vslacc_lmer))

model_tslacc_lmer <- glmer(corr~Subgroup+(1|PartID)+(1|trial),data=tsl_accuracy,family="binomial")
print(summary(model_tslacc_lmer))
```
## plot the accuracy by group and task
```{r,echo=FALSE}
stat.test <- all_acc_table %>%
  group_by(task) %>%
  tukey_hsd(subj_corr~Subgroup)
stat.test
stat.test <- stat.test %>% add_xy_position(x = "group", fun = "mean_se")
all_acc_table$Subgroup = as.factor(all_acc_table$Subgroup)
ggbarplot(all_acc_table, x = "Subgroup", y = "subj_corr", fill = 
            "Subgroup", add = "mean_se", facet.by = c("task")) +
  facet_wrap(vars(task),scales="free")+
  stat_pvalue_manual(stat.test, hide.ns = TRUE, tip.length = 0, step.increase = 0) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
  scale_fill_brewer(palette = 'Set1') +
  ylab(label = '% Correct') +
  xlab(label = 'Group')
```
## alternative plots
```{r,echo=FALSE}
ggplot() +
  geom_bar(aes(x = Subgroup,y = subj_corr,fill = Subgroup),data=all_acc_table,colour = '#000000',fun.data = mean_sdl,fun.args = list(mult = 1),stat = 'summary',position = position_dodge(width = 0.9)) +
  theme_classic(base_size = 18.0) +
  ylab(label = '% Correct') +
  xlab(label = 'Group') +
  #coord_cartesian(ylim = c(0.3,1)) +
  geom_errorbar(aes(y = subj_corr, x = Subgroup),data=all_acc_table,size = 0.3,width = 0.2,fun.y = function(x) mean(x),fun.ymin = function(x) mean(x) - sd(x)/sqrt(length(x)),fun.ymax = function(x) mean(x) + sd(x)/sqrt(length(x)) ,stat = 'summary')+
  geom_beeswarm(aes(x = Subgroup,y = subj_corr, colour = Subgroup),data=all_acc_table,dodge.width=0.9,cex=2.5) +
  facet_wrap(task~.) +
  scale_fill_brewer(palette = 'Set1') + 
  scale_color_manual(values=cbbPalette)
```

#A t-test to compare between Dylexia and Typical group
##In tsl
```{r,echo=FALSE}
t.test(DD_acc_tsl,TYP_acc_tsl)
```

##In vsl
```{r,echo=FALSE}
t.test(DD_acc_vsl,TYP_acc_vsl)
```

## save output files into a wide format for individual difference analysis
```{r,echo=FALSE}
all_acc_wide=cast(all_acc_table,subj+group~task,value="subj_corr")
colnames(all_acc_wide)[3]="aud_acc"
colnames(all_acc_wide)[4]="vis_acc"
all_slope_wide_slope_s=cast(all_subj_slope,subj~task,value="rt_slope_scale")
colnames(all_slope_wide_slope_s)[2]="aud_slope_scale"
colnames(all_slope_wide_slope_s)[3]="vis_slope_scale"
all_slope_wide_rt=cast(all_subj_slope,subj~task,value="mean_rt")
colnames(all_slope_wide_rt)[2]="aud_fam_rt"
colnames(all_slope_wide_rt)[3]="vis_fam_rt"
all_slope_wide_dprime=cast(all_subj_slope,subj~task,value="dprime")
colnames(all_slope_wide_dprime)[2]="aud_fam_dprime"
colnames(all_slope_wide_dprime)[3]="vis_fam_dprime"
all_rt_wide = merge(all_slope_wide_slope_s,all_slope_wide_rt)
all_rt_wide = merge(all_rt_wide,all_slope_wide_dprime)
all_sl_wide = merge(all_acc_wide,all_rt_wide)
write.csv(all_sl_wide,"/Users/zhenghanqi/Dropbox (MIT)/UDel/projects/collaboration/abcd/git/procedural-learning/sl_analysis/all_sl_wide.csv")
```

